---
title: "11.17_localisation_analysis"
output: html_document
date: "2025-02-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
```

```{r}

path <- "11.17_files/PCC_calculation/PCC_results"

# Get list of CSV files
file_list <- list.files(path, pattern = "*.csv", full.names = TRUE)

# Function to read and process each file
read_and_process <- function(file) {
  df <- read_csv(file)  # Read file
  
  # Extract filename without path
  filename <- basename(file)
  filename <- tools::file_path_sans_ext(filename)  # Remove .csv extension
  
  # Extract KRAS, BRAF, and image number
  matches <- str_match(filename, "(KRASWT|KRASG12D)_(BRAF_WT|BRAF_AAAA|BRAF_R188L)_(\\d+)")
  
  if (!is.na(matches[1])) {
    df <- df %>%
      mutate(
        KRAS_type = matches[2],
        BRAF_type = matches[3],
        image_no = as.integer(matches[4])
      )
  }
  
  return(df)
}

# Read all files and combine into one dataframe
all_images <- map_dfr(file_list, read_and_process)


all_images <- all_images %>% 
  rename(mean_intensity_KRAS = Mean_Intensity_Channel1, mean_intensity_BRAF = Mean_Intensity_Channel2,
         sum_intensity_KRAS = Sum_Intensity_Channel1, sum_intensity_BRAF = Sum_Intensity_Channel2,
         Area = Area_Square_Microns)

write.csv(all_images, "11.17_files/PCC_calculation/all_images_PCC.csv")
```

segmentation was done so that all membrane was included (ie more loosely) - this means that for two cells next to each other if one was transfected and other wasnt this will include the part of the membrane of the transfected cell- which will falsify results
(also zero zero pixels correlate pretty well..)
set threshold for minimum mean intensity values of both channels to filter for cells that are fully transfected

assume: 25% transfected to get rough threshold values

```{r}
#need to set threshhold for transfected cells
percentile_75_KRAS <- quantile(all_images$mean_intensity_KRAS, 0.76, na.rm = TRUE)
percentile_75_BRAF <- quantile(all_images$mean_intensity_BRAF, 0.76, na.rm = TRUE)


ggplot(all_images, aes(x = mean_intensity_KRAS)) +
  geom_histogram(bins = 50, fill = "blue", alpha = 0.5) +
  geom_vline(xintercept = percentile_75_KRAS, color = "red", linetype = "dashed", size = 1) +  
  annotate("text", x = percentile_75_KRAS, y = Inf, label = paste0("75th percentile: ", round(percentile_75_KRAS, 2)), 
           vjust = -0.5, color = "red", fontface = "bold") +  
  theme_minimal() +
  labs(title = "Distribution of mean_intensity_KRAS",
       x = "Mean Intensity KRAS",
       y = "Count")

ggplot(all_images, aes(x = mean_intensity_BRAF)) +
  geom_histogram(bins = 50, fill = "blue", alpha = 0.5) +
  geom_vline(xintercept = percentile_75_BRAF, color = "red", linetype = "dashed", size = 1) +  
  annotate("text", x = percentile_75_BRAF, y = Inf, label = paste0("75th percentile: ", round(percentile_75_BRAF, 2)), 
           vjust = -0.5, color = "red", fontface = "bold") +  
  theme_minimal() +
  labs(title = "Distribution of mean_intensity_BRAF",
       x = "Mean Intensity BRAF",
       y = "Count")


```

```{r}
#remove  non-transfected cells
all_images_filter <- all_images %>% 
  filter(mean_intensity_BRAF > percentile_75_BRAF & mean_intensity_KRAS > percentile_75_KRAS,
         mean_intensity_KRAS <3000 & mean_intensity_BRAF < 3000) #remove massively overexpressed, could also set threshold like above
#remove missegmented cells

all_images_filter <- all_images_filter %>% 
  filter(Area > 50) #threshold set after visual inspection, can modify this

#could improve QC, also by visual inspection of debug images, better filters

write.csv(all_images_filter, "11.17_files/PCC_calculation/all_images_filtered_PCC.csv")
```

```{r}

colours = c("#2D7DD2", "#9A275A", "#F45D01")

#or plot however
all_images_filter %>% 
    mutate(BRAF_type = factor(BRAF_type, 
                            levels = c("BRAF_WT", "BRAF_AAAA", "BRAF_R188L"),
                            labels = c("WT", "AAAA", "R188L"))) %>% 
  mutate(KRAS_type = factor(KRAS_type, 
                            levels = c("KRASWT", "KRASG12D"),
                            labels = c("KRAS WT", " KRAS G12D"))) %>% 
  ggplot(aes(BRAF_type, Pearson_Correlation, colour = BRAF_type)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.2) +
  facet_wrap( ~ KRAS_type) +
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        legend.position = "none",
        axis.title.y = element_text(size = 18),
        axis.text.x = element_text (size = 16),
        axis.text.y = element_text (size = 12),
        strip.text = element_text(size = 18))+
  scale_colour_manual(values = colours) +
scale_y_continuous(breaks = seq(-1, 1, by = 0.2)) +
  ylab("Pearson Correlation Coefficient")

ggsave("11.17_files/PCC_calculation/plots/Pearson_Correlation_v1.png", width = 8, height = 5)
```

